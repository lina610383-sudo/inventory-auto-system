import streamlit as st
import pandas as pd
import re
import io
from openpyxl import load_workbook
from openpyxl.utils import get_column_letter
from copy import copy

# è¨­å®šé é¢è³‡è¨Š
st.set_page_config(page_title="é ˜ç”¨å–®è‡ªå‹•åŒ–ç³»çµ±", layout="wide")
st.title("ğŸ“¦ é ˜ç”¨å–®è‡ªå‹•åŒ–ç”Ÿæˆç³»çµ±")
st.markdown("---")

def get_col_idx_by_value(ws, row_idx, value):
    """åœ¨æŒ‡å®šåˆ—ä¸­æœå°‹ç‰¹å®šå€¼çš„æ¬„ä½ç´¢å¼• (1-based)"""
    for col in range(1, ws.max_column + 2):
        cell_val = ws.cell(row=row_idx, column=col).value
        if cell_val and str(cell_val).strip() == str(value).strip():
            return col
    return None

def process_inventory(file):
    # 1. è®€å– Excel æª”æ¡ˆçµæ§‹
    try:
        wb = load_workbook(file)
    except Exception as e:
        st.error(f"æª”æ¡ˆè®€å–å¤±æ•—: {e}")
        return None, None

    # 2. å°‹æ‰¾æœ€æ–°çš„ã€Œæœªé–‹å–®ã€åˆ†é 
    sheet_names = wb.sheetnames
    pattern = r"\(èªªæ˜\) é ˜ç”¨æ˜ç´°_(\d+) \(æœªé–‹å–®\)"
    target_sheets = []
    
    for name in sheet_names:
        match = re.search(pattern, name)
        if match:
            target_sheets.append((match.group(1), name))
    
    if not target_sheets:
        st.error("æ‰¾ä¸åˆ°ç¬¦åˆæ ¼å¼ã€(èªªæ˜) é ˜ç”¨æ˜ç´°_æ—¥æœŸ (æœªé–‹å–®)ã€çš„åˆ†é ã€‚")
        return None, None
    
    # æ’åºå–æ—¥æœŸæœ€å¤§çš„
    latest_date_str, source_sheet_name = sorted(target_sheets, key=lambda x: x[0])[-1]
    st.success(f"ğŸ“ é–å®šæœ€æ–°åˆ†é ï¼š`{source_sheet_name}` (æ—¥æœŸ: {latest_date_str})")

    # 3. è®€å–è³‡æ–™
    # è®€å–æ›å¸³äººæ¸…å–®
    if "æ›å¸³äººæ¸…å–®" not in sheet_names:
        st.error("æ‰¾ä¸åˆ°ã€æ›å¸³äººæ¸…å–®ã€åˆ†é ï¼")
        return None, None
    
    # ä½¿ç”¨ pandas è®€å–è³‡æ–™ä»¥æ–¹ä¾¿è™•ç†
    df_payers = pd.read_excel(file, sheet_name="æ›å¸³äººæ¸…å–®")
    # è™•ç†æ›å¸³äººæ¸…å–®ï¼šç¬¬ä¸€æ¬„å¦‚æœæ˜¯é¡åˆ¥ (IEC/ICC)ï¼Œå¯èƒ½æœƒæœ‰åˆä½µå„²å­˜æ ¼å°è‡´ç©ºå€¼ï¼Œéœ€å¡«è£œ
    df_payers.iloc[:, 0] = df_payers.iloc[:, 0].ffill()
    
    # å»ºç«‹æ›å¸³äººå°ç…§å­—å…¸: Name -> {ID, Unit, Type}
    payer_map = {}
    for _, row in df_payers.iterrows():
        p_name = row.get('é ˜ç”¨äºº')
        if pd.notna(p_name):
            clean_name = str(p_name).strip()
            payer_map[clean_name] = {
                'type': str(row.iloc[0]).strip() if pd.notna(row.iloc[0]) else 'IEC', 
                'unit': str(row.get('å–®ä½')).strip(),
                'id': str(row.get('æ›å¸³äºº')).strip()
            }

    # è®€å–æ˜ç´°åˆ†é 
    df_detail = pd.read_excel(file, sheet_name=source_sheet_name, header=1) 
    
    # 4. æº–å‚™å¯«å…¥ IEC èˆ‡ ICC æ¨¡æ¿
    template_iec_name = "é ˜ç”¨å–®æ ¼å¼ç¯„ä¾‹ IEC"
    template_icc_name = "é ˜ç”¨å–®æ ¼å¼ç¯„ä¾‹ ICC"
    
    ws_iec = None
    ws_icc = None
    
    if template_iec_name in wb.sheetnames:
        ws_iec = wb.copy_worksheet(wb[template_iec_name])
        ws_iec.title = f"IEC_Output_{latest_date_str}"
    
    if template_icc_name in wb.sheetnames:
        ws_icc = wb.copy_worksheet(wb[template_icc_name])
        ws_icc.title = f"ICC_Output_{latest_date_str}"

    iec_header_row = 5
    iec_start_row = 6
    icc_header_row = 5
    icc_start_row = 6

    current_iec_row = iec_start_row
    current_icc_row = icc_start_row

    # 5. é€è¡Œè™•ç†æ˜ç´°
    person_columns = [col for col in df_detail.columns if str(col).strip() in payer_map]
    
    for idx, row in df_detail.iterrows():
        desc = row.get('Description')
        pn = row.get('IEC PN')
        supplier = row.get('Supplier')
        
        desc_val = desc if pd.notna(desc) else "ã€é ˆè£œè³‡æ–™ã€‘"
        pn_val = pn if pd.notna(pn) else "ã€é ˆè£œè³‡æ–™ã€‘"
        supplier_val = supplier if pd.notna(supplier) else "ã€é ˆè£œè³‡æ–™ã€‘"
        
        for person in person_columns:
            qty = row[person]
            if pd.notna(qty) and qty > 0:
                p_info = payer_map.get(str(person).strip())
                if not p_info: continue

                p_id = p_info['id']
                p_type = p_info['type']
                
                target_ws = None
                if "IEC" in p_type.upper() and ws_iec:
                    target_ws = ws_iec
                    target_row = current_iec_row
                    header_row = iec_header_row
                    target_ws.cell(row=target_row, column=1, value=desc_val)
                    target_ws.cell(row=target_row, column=2, value=supplier_val)
                    target_ws.cell(row=target_row, column=5, value=pn_val)
                    current_iec_row += 1
                elif "ICC" in p_type.upper() and ws_icc:
                    target_ws = ws_icc
                    target_row = current_icc_row
                    header_row = icc_header_row
                    target_ws.cell(row=target_row, column=1, value=desc_val)
                    target_ws.cell(row=target_row, column=5, value=pn_val)
                    current_icc_row += 1
                
                if target_ws:
                    col_idx = get_col_idx_by_value(target_ws, header_row, p_id)
                    if not col_idx:
                        col_idx = target_ws.max_column + 1
                        target_ws.cell(row=header_row, column=col_idx, value=p_id)
                    target_ws.cell(row=target_row, column=col_idx, value=qty)

    # 6. æ›´æ–°ç‹€æ…‹åˆ†é 
    if source_sheet_name in wb.sheetnames:
        wb[source_sheet_name].title = f"(èªªæ˜) é ˜ç”¨æ˜ç´°_{latest_date_str} (å·²é–‹å–®)"

    output = io.BytesIO()
    wb.save(output)
    output.seek(0)
    return output, latest_date_str

# ä»‹é¢
file_upload = st.file_uploader("ğŸ“‚ ä¸Šå‚³é ˜ç”¨å–® Excel", type=["xlsx"])
if file_upload:
    if st.button("ğŸš€ é–‹å§‹è‡ªå‹•ç”¢å‡º"):
        processed_file, date_str = process_inventory(file_upload)
        if processed_file:
            st.download_button("ğŸ“¥ ä¸‹è¼‰å®Œæˆæª”æ¡ˆ", processed_file, f"é ˜ç”¨å–®_{date_str}_å·²å®Œæˆ.xlsx")